<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escáner Inventario</title>
  <style>
    body{font-family:system-ui,Arial; margin:16px; max-width:720px}
    #video{width:100%; max-width:520px; border:1px solid #ddd; border-radius:12px}
    .row{margin-top:12px}
    button{padding:12px 14px; font-size:16px; margin-right:8px; margin-top:8px}
    input{padding:10px; font-size:16px; width:100%}
    .ok{color:green} .bad{color:crimson}
    .pill{display:inline-block; padding:6px 10px; background:#f3f3f3; border-radius:999px}
    .grid{display:grid; grid-template-columns:1fr; gap:8px}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:14px}
    th{background:#fafafa}
    .muted{color:#666; font-size:13px}
    .toggles{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:8px}
    .toggles label{display:flex; gap:6px; align-items:center; user-select:none}
  </style>
</head>
<body>
  <h2>Escáner Inventario — Sucursal 1</h2>
  <p class="pill">Solo escanear · Sin cantidades</p>
  <p class="muted">Modo actual: <b id="modeLabel">Guardar local</b></p>

  <video id="video" playsinline></video>

  <div class="row">
    <button id="startBtn">Iniciar cámara</button>
    <button id="stopBtn" disabled>Detener</button>
  </div>

  <div class="row toggles">
    <label><input type="checkbox" id="soundOn" checked> Sonido</label>
    <label><input type="checkbox" id="vibrateOn" checked> Vibración</label>
    <label><input type="checkbox" id="flashOn" checked> Flash</label>
  </div>

  <div class="row grid">
    <div>
      <label>Último código:</label>
      <input id="last" readonly placeholder="Aún no hay escaneos" />
    </div>
    <div class="muted">Escaneos guardados: <b id="count">0</b></div>
    <div class="row" id="status"></div>
  </div>

  <div class="row">
    <button id="exportBtn">Exportar CSV</button>
    <button id="copyBtn">Copiar últimos 50</button>
    <button id="clearBtn">Borrar todo</button>
  </div>

  <table>
    <thead>
      <tr><th>#</th><th>Código</th><th>Fecha/Hora</th><th>Ubicación</th></tr>
    </thead>
    <tbody id="list"></tbody>
  </table>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";

    // === CONFIG ===
    const LOCATION = "Sucursal 1";
    // =================

    const STORAGE_KEY = "inventario_scan_v1";

    const video = document.getElementById("video");
    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const last     = document.getElementById("last");
    const statusEl = document.getElementById("status");
    const listEl   = document.getElementById("list");
    const countEl  = document.getElementById("count");

    const exportBtn = document.getElementById("exportBtn");
    const clearBtn  = document.getElementById("clearBtn");
    const copyBtn   = document.getElementById("copyBtn");

    const soundOn  = document.getElementById("soundOn");
    const vibrateOn= document.getElementById("vibrateOn");
    const flashOn  = document.getElementById("flashOn");

    const codeReader = new BrowserMultiFormatReader();
    let controls = null;
    let lastScan = { code: null, t: 0 };

    function setStatus(msg, ok=true){
      statusEl.className = ok ? "ok" : "bad";
      statusEl.textContent = msg;
    }

    // ===== Feedback (beep / vibrate / flash) =====
    let audioCtx = null;
    function beep(){
      if(!soundOn.checked) return;
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "square";
        o.frequency.value = 880;
        g.gain.value = 0.06;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        setTimeout(() => o.stop(), 90);
      }catch{}
    }

    function vibrate(){
      if(!vibrateOn.checked) return;
      try{
        if(navigator.vibrate) navigator.vibrate(120);
      }catch{}
    }

    function flashOK(){
      if(!flashOn.checked) return;
      const prev = document.body.style.backgroundColor;
      document.body.style.backgroundColor = "#d1fae5";
      setTimeout(() => { document.body.style.backgroundColor = prev; }, 120);
    }
    // ============================================

    function loadScans(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch{ return []; }
    }
    function saveScans(scans){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(scans));
    }

    function fmtDate(iso){
      const d = new Date(iso);
      return d.toLocaleString();
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function render(){
      const scans = loadScans();
      countEl.textContent = scans.length;
      listEl.innerHTML = scans.slice().reverse().slice(0, 30).map((s, idx) => {
        const n = scans.length - idx;
        return `<tr>
          <td>${n}</td>
          <td>${escapeHtml(s.barcode)}</td>
          <td>${escapeHtml(fmtDate(s.timestamp))}</td>
          <td>${escapeHtml(s.location)}</td>
        </tr>`;
      }).join("");
    }

    function addScan(code){
      const scans = loadScans();
      const item = { barcode: code, location: LOCATION, timestamp: new Date().toISOString() };
      scans.push(item);
      saveScans(scans);
      render();
    }

    function toCSV(scans){
      const header = ["barcode","location","timestamp"];
      const lines = [header.join(",")];
      for(const s of scans){
        const row = [s.barcode, s.location, s.timestamp].map(v => `"${String(v).replaceAll('"','""')}"`);
        lines.push(row.join(","));
      }
      return lines.join("\n");
    }

    function downloadFile(filename, text){
      const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ===== Main =====
    startBtn.onclick = async () => {
      try{
        // En iPhone, el audio requiere interacción del usuario: esto ayuda
        if(soundOn.checked){
          try{
            audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
            await audioCtx.resume?.();
          }catch{}
        }

        setStatus("Iniciando cámara…");
        controls = await codeReader.decodeFromVideoDevice(undefined, video, async (result) => {
          if(!result) return;

          const code = (result.getText() || "").trim();
          const now = Date.now();

          // anti-rebote (no repetir el mismo código en <1.2s)
          if(lastScan.code === code && (now - lastScan.t) < 1200) return;
          lastScan = { code, t: now };

          last.value = code;
          addScan(code);

          // feedback
          beep();
          vibrate();
          flashOK();

          setStatus("Guardado ✅ (" + code + ")");
        });

        startBtn.disabled = true;
        stopBtn.disabled = false;
        setStatus("Listo. Escanea un código.");
      }catch(e){
        setStatus("No se pudo abrir la cámara: " + e.message, false);
      }
    };

    stopBtn.onclick = () => {
      try{ controls?.stop(); }catch{}
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setStatus("Cámara detenida.");
    };

    exportBtn.onclick = () => {
      const scans = loadScans();
      if(!scans.length){
        setStatus("No hay nada para exportar.", false);
        return;
      }
      const csv = toCSV(scans);
      const name = `inventario_${LOCATION.replaceAll(" ","_")}_${new Date().toISOString().slice(0,10)}.csv`;
      downloadFile(name, csv);
      setStatus("CSV exportado ✅");
    };

    copyBtn.onclick = async () => {
      const scans = loadScans().slice(-50);
      if(!scans.length){
        setStatus("No hay nada para copiar.", false);
        return;
      }
      const text = scans.map(s => `${s.barcode}\t${s.location}\t${s.timestamp}`).join("\n");
      try{
        await navigator.clipboard.writeText(text);
        setStatus("Copiado ✅ (últimos 50)");
      }catch{
        setStatus("No pude copiar (bloqueo del navegador). Usa Exportar CSV.", false);
      }
    };

    clearBtn.onclick = () => {
      if(!confirm("¿Seguro que quieres borrar TODOS los escaneos guardados en este dispositivo?")) return;
      saveScans([]);
      render();
      setStatus("Lista borrada.");
    };

    render();
  </script>
</body>
</html>

